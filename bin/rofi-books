#!/bin/bash

BOOKS_DIR="$HOME/Books"

extract_title() {
    local filename="$1"
    local title
    title="${filename%.*}"
    title=$(echo "$title" | sed 's/ - / â”‚ /g')
    echo "$title"
}

open_book() {
    local file="$1"
    local extension="${file##*.}"

    case "$extension" in
        pdf|djvu)
            sioyek "$file" &
            ;;
        epub)
            foliate "$file" &
            ;;
        *)
            echo "Unsupported file type: $extension" >&2
            ;;
    esac
}

show_books_with_categories() {
    find "$BOOKS_DIR" -type f \( -name "*.pdf" -o -name "*.epub" -o -name "*.djvu" \) | while read -r file; do
        filename=$(basename "$file")
        category=$(basename "$(dirname "$file")")
        title=$(extract_title "$filename")
        echo "[$category] $title|$file"
    done
}

select_by_category() {
    category=$(find "$BOOKS_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | rofi -dmenu -i -p "Select category:")
    if [ -z "$category" ]; then
        exit 0
    fi
    books=$(find "$BOOKS_DIR/$category" -type f \( -name "*.pdf" -o -name "*.epub" -o -name "*.djvu" \) | while read -r file; do
        filename=$(basename "$file")
        title=$(extract_title "$filename")
        echo "$title|$file"
    done)
    if [ -z "$books" ]; then
        echo "No books found in category: $category" >&2
        exit 1
    fi
    selected=$(echo "$books" | cut -d'|' -f1 | rofi -dmenu -i -p "Select book from $category:")
    if [ -n "$selected" ]; then
        file=$(echo "$books" | grep "^$selected|" | cut -d'|' -f2)
        if [ -n "$file" ]; then
            open_book "$file"
        fi
    fi
}

show_hierarchical() {
    temp_file=$(mktemp)
    find "$BOOKS_DIR" -mindepth 1 -maxdepth 1 -type d | sort | while read -r category_path; do
        category=$(basename "$category_path")
        echo "ðŸ“ $category" >> "$temp_file"
        find "$category_path" -type f \( -name "*.pdf" -o -name "*.epub" -o -name "*.djvu" \) | while read -r file; do
            filename=$(basename "$file")
            title=$(extract_title "$filename")
            echo "   ðŸ“– $title|$file" >> "$temp_file"
        done
    done
    selected=$(cat "$temp_file" | rofi -dmenu -i -p "Select:")
    rm "$temp_file"
    if [[ "$selected" == *"|"* ]]; then
        file=$(echo "$selected" | cut -d'|' -f2)
        open_book "$file"
    fi
}

case "${1:-category}" in
    "flat")
        books=$(show_books_with_categories)
        selected=$(echo "$books" | cut -d'|' -f1 | rofi -dmenu -i -p "Select a book:")
        if [ -n "$selected" ]; then
            file=$(echo "$books" | grep "^$(echo "$selected" | sed 's/\[/\\[/g; s/\]/\\]/g')|" | cut -d'|' -f2)
            if [ -n "$file" ]; then
                open_book "$file"
            fi
        fi
        ;;
    "category"|*)
        select_by_category
        ;;
    "tree")
        show_hierarchical
        ;;
esac
